@startuml Phase3_Complete_User_Flow
!theme plain
skinparam backgroundColor #FEFEFE
skinparam handwritten false

title Phase 3: Complete User Flow - Registration to Trading

actor User
participant "Frontend\n(React)" as Frontend
participant "API Gateway\n(Rust/Axum)" as API
participant "Database\n(PostgreSQL)" as DB
participant "Blockchain\n(Solana)" as Blockchain
participant "WebSocket\nService" as WS

== 1. User Registration ==

User -> Frontend: Fill registration form
activate Frontend
Frontend -> API: POST /api/auth/wallet/register\n{username, email, password, create_wallet}
activate API
API -> API: Validate input
API -> API: Hash password (Argon2)
API -> Blockchain: Create wallet keypair
activate Blockchain
Blockchain --> API: Wallet address + private key
deactivate Blockchain
API -> Blockchain: Request airdrop (testnet)
activate Blockchain
Blockchain --> API: Airdrop signature
deactivate Blockchain
API -> DB: INSERT user with wallet_address
activate DB
DB --> API: User created
deactivate DB
API -> API: Generate JWT token
API --> Frontend: {access_token, wallet_info}
deactivate API
Frontend --> User: Show success + wallet info
deactivate Frontend

== 2. User Login ==

User -> Frontend: Enter credentials
activate Frontend
Frontend -> API: POST /api/auth/wallet/login\n{username, password}
activate API
API -> DB: SELECT user WHERE username
activate DB
DB --> API: User record
deactivate DB
API -> API: Verify password
API -> Blockchain: Get wallet balance
activate Blockchain
Blockchain --> API: Balance
deactivate Blockchain
API -> API: Generate JWT token
API --> Frontend: {access_token, user, wallet_info}
deactivate API
Frontend --> User: Redirect to dashboard
deactivate Frontend

== 3. Submit Meter Reading ==

User -> Frontend: Submit energy reading
activate Frontend
Frontend -> API: POST /api/meters/submit-reading\n{meter_id, reading_kwh, timestamp}
activate API
API -> API: Validate JWT token
API -> DB: INSERT meter_reading
activate DB
DB --> API: Reading ID
deactivate DB
API --> Frontend: {reading_id, status: pending_mint}
deactivate API
Frontend --> User: Show success
deactivate Frontend

== 4. Mint Energy Tokens ==

User -> Frontend: Click "Mint Tokens"
activate Frontend
Frontend -> API: POST /api/tokens/mint-from-reading\n{reading_id, wallet_address}
activate API
API -> DB: SELECT meter_reading
activate DB
DB --> API: Reading data
deactivate DB
API -> API: Calculate token amount\n(1 token = 1 kWh)
API -> Blockchain: Submit mint transaction\n(Authority wallet signs)
activate Blockchain
Blockchain --> API: Transaction signature
deactivate Blockchain
API -> DB: UPDATE meter_reading\nSET minted = true
activate DB
DB --> API: Updated
deactivate DB
API --> Frontend: {transaction_signature, tokens_minted}
deactivate API
Frontend --> User: Show minted tokens
deactivate Frontend

== 5. Create Trading Order ==

User -> Frontend: Fill order form
activate Frontend
Frontend -> API: POST /api/trading/orders\n{order_type, price, amount}
activate API
API -> API: Validate JWT token
API -> Blockchain: Check wallet balance
activate Blockchain
Blockchain --> API: Balance sufficient
deactivate Blockchain
API -> DB: INSERT trading_order
activate DB
DB --> API: Order ID
deactivate DB
API -> Blockchain: Submit order to blockchain
activate Blockchain
Blockchain --> API: Transaction signature
deactivate Blockchain
API -> WS: Broadcast order book update
activate WS
WS --> Frontend: Order book updated
deactivate WS
API --> Frontend: {order_id, status: active}
deactivate API
Frontend --> User: Show order created
deactivate Frontend

== 6. Order Matching (Automated) ==

note over API: Market Clearing Engine\nRuns every 15 minutes

API -> DB: SELECT active orders
activate DB
DB --> API: Buy & Sell orders
deactivate DB
API -> API: Match orders\n(Price-time priority)
API -> DB: INSERT order_matches
activate DB
DB --> API: Matches created
deactivate DB

== 7. Settlement Execution ==

loop For each match
    API -> Blockchain: Submit settlement transaction\n(Transfer tokens + payment)
    activate Blockchain
    Blockchain --> API: Transaction signature
    deactivate Blockchain
    API -> DB: UPDATE order status\nCREATE transaction record
    activate DB
    DB --> API: Updated
    deactivate DB
end

API -> WS: Broadcast order matched
activate WS
WS --> Frontend: "Your order matched!"
deactivate WS
Frontend --> User: Show notification
Frontend --> User: Update order status

== 8. View Transaction History ==

User -> Frontend: Open transaction history
activate Frontend
Frontend -> API: GET /api/trading/history
activate API
API -> API: Validate JWT token
API -> DB: SELECT transactions\nWHERE user_id = current_user
activate DB
DB --> API: Transaction list
deactivate DB
API --> Frontend: {transactions, total_volume, total_trades}
deactivate API
Frontend --> User: Display transaction history
deactivate Frontend

== 9. Real-Time Updates (WebSocket) ==

note over Frontend, WS: Continuous connection for live updates

WS -> Frontend: order_book_update
Frontend -> Frontend: Update UI
WS -> Frontend: order_matched
Frontend -> Frontend: Show notification
WS -> Frontend: order_filled
Frontend -> Frontend: Update order status
WS -> Frontend: epoch_transition
Frontend -> Frontend: Refresh market data

@enduml
