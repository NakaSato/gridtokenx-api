# ğŸ“‹ Call Sequence Diagrams

**GridTokenX Platform - Inter-Program Communication Patterns & Execution Flows**

> **ğŸ“˜ For professional UML sequence diagrams, see:**
> - [CPI Patterns Diagram](../anchor/ANCHOR_ARCHITECTURE_DIAGRAMS.puml#ANCHOR_CPI_PATTERNS)
> - [All Sequence Diagrams](../anchor/ANCHOR_ARCHITECTURE_DIAGRAMS.puml)
> - [CPI Security Documentation](../anchor/ANCHOR_ARCHITECTURE_OVERVIEW.md#cross-program-invocations-cpi)
> 
> **Note**: This document provides ASCII-based call sequences. For professional PlantUML diagrams, refer to the Anchor documentation.

---

## Table of Contents

1. [Oracle Program Sequences](#oracle-program-sequences)
2. [Governance Program Sequences](#governance-program-sequences)
3. [Registry Program Sequences](#registry-program-sequences)
4. [Energy-Token Program Sequences](#energy-token-program-sequences)
5. [Trading Program Sequences](#trading-program-sequences)
6. [End-to-End Business Sequences](#end-to-end-business-sequences)
7. [Emergency Response Sequences](#emergency-response-sequences)

---

## Oracle Program Sequences

### Oracle.initialize() Sequence

```
Authority           OracleProgram       SystemProgram       Blockchain
    â”‚                     â”‚                   â”‚                â”‚
    â”‚â”€â”€initialize()â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                   â”‚                â”‚
    â”‚  (api_gateway)       â”‚                   â”‚                â”‚
    â”‚                      â”‚                   â”‚                â”‚
    â”‚                      â”‚â”€create_pda()â”€â”€â”€â”€â”€â–ºâ”‚                â”‚
    â”‚                      â”‚  [seed: "oracle_data"]             â”‚
    â”‚                      â”‚                   â”‚                â”‚
    â”‚                      â”‚â—„â”€pda_createdâ”€â”€â”€â”€â”€â”€â”‚                â”‚
    â”‚                      â”‚                   â”‚                â”‚
    â”‚                      â”‚â”€set_authority()â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
    â”‚                      â”‚â”€set_api_gateway()â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
    â”‚                      â”‚â”€set_active(true)â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
    â”‚                      â”‚â”€set_created_at()â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
    â”‚                      â”‚                   â”‚                â”‚
    â”‚â—„â”€successâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                   â”‚                â”‚
    â”‚                      â”‚                   â”‚                â”‚
```

### Oracle.submit_meter_reading() Sequence

```
APIGateway         OracleProgram       RegistryProgram     Blockchain
    â”‚                     â”‚                   â”‚                â”‚
    â”‚â”€â”€submit_reading()â”€â”€â”€â”€â–ºâ”‚                   â”‚                â”‚
    â”‚  (meter_id, data)    â”‚                   â”‚                â”‚
    â”‚                      â”‚                   â”‚                â”‚
    â”‚                      â”‚â”€validate_caller()â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
    â”‚                      â”‚â”€check_active()â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
    â”‚                      â”‚                   â”‚                â”‚
    â”‚                      â”‚â”€update_readings()â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
    â”‚                      â”‚â”€emit_event()â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
    â”‚                      â”‚                   â”‚                â”‚
    â”‚                      â”‚â”€update_meter()â”€â”€â”€â”€â–ºâ”‚                â”‚
    â”‚                      â”‚                   â”‚â”€update_data()â”€â”€â–ºâ”‚
    â”‚                      â”‚                   â”‚â—„â”€updatedâ”€â”€â”€â”€â”€â”€â”€â”‚
    â”‚                      â”‚â—„â”€successâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                â”‚
    â”‚                      â”‚                   â”‚                â”‚
    â”‚â—„â”€successâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                   â”‚                â”‚
    â”‚                      â”‚                   â”‚                â”‚
```

### Oracle.trigger_market_clearing() Sequence

```
APIGateway         OracleProgram       TradingProgram      Blockchain
    â”‚                     â”‚                   â”‚                â”‚
    â”‚â”€â”€trigger_clearing()â”€â”€â–ºâ”‚                   â”‚                â”‚
    â”‚                      â”‚                   â”‚                â”‚
    â”‚                      â”‚â”€validate_caller()â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
    â”‚                      â”‚â”€check_active()â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
    â”‚                      â”‚                   â”‚                â”‚
    â”‚                      â”‚â”€update_clearing()â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
    â”‚                      â”‚â”€emit_event()â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
    â”‚                      â”‚                   â”‚                â”‚
    â”‚                      â”‚â”€initiate_matching()â–ºâ”‚               â”‚
    â”‚                      â”‚                   â”‚â”€match_orders()â”€â–ºâ”‚
    â”‚                      â”‚                   â”‚â—„â”€trades_executedâ”‚
    â”‚                      â”‚â—„â”€successâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                â”‚
    â”‚                      â”‚                   â”‚                â”‚
    â”‚â—„â”€successâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                   â”‚                â”‚
    â”‚                      â”‚                   â”‚                â”‚
```

---

## Governance Program Sequences

### Governance.initialize_poa() Sequence

```
Authority          GovernanceProgram   SystemProgram       Blockchain
    â”‚                     â”‚                   â”‚                â”‚
    â”‚â”€â”€initialize_poa()â”€â”€â”€â”€â–ºâ”‚                   â”‚                â”‚
    â”‚                      â”‚                   â”‚                â”‚
    â”‚                      â”‚â”€create_pda()â”€â”€â”€â”€â”€â–ºâ”‚                â”‚
    â”‚                      â”‚  [seed: "poa_config"]              â”‚
    â”‚                      â”‚                   â”‚                â”‚
    â”‚                      â”‚â—„â”€pda_createdâ”€â”€â”€â”€â”€â”€â”‚                â”‚
    â”‚                      â”‚                   â”‚                â”‚
    â”‚                      â”‚â”€set_authority()â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
    â”‚                      â”‚â”€set_config()â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
    â”‚                      â”‚â”€set_limits()â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
    â”‚                      â”‚â”€emit_event()â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
    â”‚                      â”‚                   â”‚                â”‚
    â”‚â—„â”€successâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                   â”‚                â”‚
    â”‚                      â”‚                   â”‚                â”‚
```

### Governance.issue_erc() Sequence

```
Authority          GovernanceProgram   SystemProgram       Blockchain
    â”‚                     â”‚                   â”‚                â”‚
    â”‚â”€â”€issue_erc()â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                   â”‚                â”‚
    â”‚  (cert_id, amount)   â”‚                   â”‚                â”‚
    â”‚                      â”‚                   â”‚                â”‚
    â”‚                      â”‚â”€validate_authority()â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
    â”‚                      â”‚â”€check_emergency()â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
    â”‚                      â”‚â”€validate_limits()â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
    â”‚                      â”‚                   â”‚                â”‚
    â”‚                      â”‚â”€create_cert_pda()â”€â–ºâ”‚                â”‚
    â”‚                      â”‚  [seed: "erc_certificate", cert_id]â”‚
    â”‚                      â”‚                   â”‚                â”‚
    â”‚                      â”‚â—„â”€cert_createdâ”€â”€â”€â”€â”€â”‚                â”‚
    â”‚                      â”‚                   â”‚                â”‚
    â”‚                      â”‚â”€set_cert_data()â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
    â”‚                      â”‚â”€update_counters()â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
    â”‚                      â”‚â”€emit_event()â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
    â”‚                      â”‚                   â”‚                â”‚
    â”‚â—„â”€erc_issuedâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                   â”‚                â”‚
    â”‚                      â”‚                   â”‚                â”‚
```

### Governance.validate_erc_for_trading() Sequence

```
Authority          GovernanceProgram   EnergyTokenProgram  Blockchain
    â”‚                     â”‚                   â”‚                â”‚
    â”‚â”€â”€validate_erc()â”€â”€â”€â”€â”€â”€â–ºâ”‚                   â”‚                â”‚
    â”‚  (cert_id)           â”‚                   â”‚                â”‚
    â”‚                      â”‚                   â”‚                â”‚
    â”‚                      â”‚â”€validate_authority()â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
    â”‚                      â”‚â”€check_emergency()â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
    â”‚                      â”‚â”€check_cert_valid()â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
    â”‚                      â”‚                   â”‚                â”‚
    â”‚                      â”‚â”€update_cert()â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
    â”‚                      â”‚â”€emit_event()â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
    â”‚                      â”‚                   â”‚                â”‚
    â”‚                      â”‚â”€trigger_tokens()â”€â”€â–ºâ”‚                â”‚
    â”‚                      â”‚                   â”‚â”€transfer_tokens()â”‚
    â”‚                      â”‚                   â”‚â—„â”€tokens_issuedâ”€â”‚
    â”‚                      â”‚â—„â”€successâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                â”‚
    â”‚                      â”‚                   â”‚                â”‚
    â”‚â—„â”€validatedâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                   â”‚                â”‚
    â”‚                      â”‚                   â”‚                â”‚
```

### Governance.emergency_pause() Sequence

```
Authority          GovernanceProgram   AllPrograms         Blockchain
    â”‚                     â”‚                   â”‚                â”‚
    â”‚â”€â”€emergency_pause()â”€â”€â”€â–ºâ”‚                   â”‚                â”‚
    â”‚                      â”‚                   â”‚                â”‚
    â”‚                      â”‚â”€validate_authority()â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
    â”‚                      â”‚â”€check_not_paused()â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
    â”‚                      â”‚                   â”‚                â”‚
    â”‚                      â”‚â”€set_paused(true)â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
    â”‚                      â”‚â”€set_timestamp()â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
    â”‚                      â”‚â”€emit_event()â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
    â”‚                      â”‚                   â”‚                â”‚
    â”‚                      â”‚â”€notify_pause()â”€â”€â”€â”€â–ºâ”‚                â”‚
    â”‚                      â”‚                   â”‚â”€block_functions()â”‚
    â”‚                      â”‚                   â”‚â—„â”€pausedâ”€â”€â”€â”€â”€â”€â”€â”€â”‚
    â”‚                      â”‚â—„â”€system_pausedâ”€â”€â”€â”€â”‚                â”‚
    â”‚                      â”‚                   â”‚                â”‚
    â”‚â—„â”€emergency_activeâ”€â”€â”€â”€â”‚                   â”‚                â”‚
    â”‚                      â”‚                   â”‚                â”‚
```

---

## Registry Program Sequences

### Registry.register_user() Sequence

```
User              RegistryProgram     SystemProgram       Blockchain
    â”‚                     â”‚                   â”‚                â”‚
    â”‚â”€â”€register_user()â”€â”€â”€â”€â”€â–ºâ”‚                   â”‚                â”‚
    â”‚  (type, location)    â”‚                   â”‚                â”‚
    â”‚                      â”‚                   â”‚                â”‚
    â”‚                      â”‚â”€validate_input()â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
    â”‚                      â”‚                   â”‚                â”‚
    â”‚                      â”‚â”€create_user_pda()â”€â–ºâ”‚                â”‚
    â”‚                      â”‚  [seed: "user", user.key()]        â”‚
    â”‚                      â”‚                   â”‚                â”‚
    â”‚                      â”‚â—„â”€user_createdâ”€â”€â”€â”€â”€â”‚                â”‚
    â”‚                      â”‚                   â”‚                â”‚
    â”‚                      â”‚â”€set_user_data()â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
    â”‚                      â”‚â”€update_registry()â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
    â”‚                      â”‚â”€emit_event()â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
    â”‚                      â”‚                   â”‚                â”‚
    â”‚â—„â”€user_registeredâ”€â”€â”€â”€â”€â”‚                   â”‚                â”‚
    â”‚                      â”‚                   â”‚                â”‚
```

### Registry.register_meter() Sequence

```
User              RegistryProgram     SystemProgram       Blockchain
    â”‚                     â”‚                   â”‚                â”‚
    â”‚â”€â”€register_meter()â”€â”€â”€â”€â–ºâ”‚                   â”‚                â”‚
    â”‚  (meter_id, type)    â”‚                   â”‚                â”‚
    â”‚                      â”‚                   â”‚                â”‚
    â”‚                      â”‚â”€validate_user()â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
    â”‚                      â”‚â”€validate_input()â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
    â”‚                      â”‚                   â”‚                â”‚
    â”‚                      â”‚â”€create_meter_pda()â–ºâ”‚                â”‚
    â”‚                      â”‚  [seed: "meter", meter_id]         â”‚
    â”‚                      â”‚                   â”‚                â”‚
    â”‚                      â”‚â—„â”€meter_createdâ”€â”€â”€â”€â”‚                â”‚
    â”‚                      â”‚                   â”‚                â”‚
    â”‚                      â”‚â”€set_meter_data()â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
    â”‚                      â”‚â”€update_user()â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
    â”‚                      â”‚â”€update_registry()â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
    â”‚                      â”‚â”€emit_event()â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
    â”‚                      â”‚                   â”‚                â”‚
    â”‚â—„â”€meter_registeredâ”€â”€â”€â”€â”‚                   â”‚                â”‚
    â”‚                      â”‚                   â”‚                â”‚
```

### Registry.update_meter_reading() Sequence

```
Oracle            RegistryProgram     GovernanceProgram   Blockchain
    â”‚                     â”‚                   â”‚                â”‚
    â”‚â”€â”€update_reading()â”€â”€â”€â”€â–ºâ”‚                   â”‚                â”‚
    â”‚  (meter_id, data)    â”‚                   â”‚                â”‚
    â”‚                      â”‚                   â”‚                â”‚
    â”‚                      â”‚â”€validate_meter()â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
    â”‚                      â”‚â”€check_active()â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
    â”‚                      â”‚                   â”‚                â”‚
    â”‚                      â”‚â”€update_meter()â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
    â”‚                      â”‚â”€update_user()â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
    â”‚                      â”‚â”€emit_event()â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
    â”‚                      â”‚                   â”‚                â”‚
    â”‚                      â”‚â”€trigger_erc()â”€â”€â”€â”€â”€â–ºâ”‚                â”‚
    â”‚                      â”‚                   â”‚â”€issue_erc()â”€â”€â”€â”€â–ºâ”‚
    â”‚                      â”‚                   â”‚â—„â”€erc_issuedâ”€â”€â”€â”€â”‚
    â”‚                      â”‚â—„â”€processingâ”€â”€â”€â”€â”€â”€â”€â”‚                â”‚
    â”‚                      â”‚                   â”‚                â”‚
    â”‚â—„â”€reading_updatedâ”€â”€â”€â”€â”€â”‚                   â”‚                â”‚
    â”‚                      â”‚                   â”‚                â”‚
```

---

## Energy-Token Program Sequences

### Energy-Token.initialize_token() Sequence

```
Authority         EnergyTokenProgram  SPLTokenProgram     Blockchain
    â”‚                     â”‚                   â”‚                â”‚
    â”‚â”€â”€initialize_token()â”€â”€â–ºâ”‚                   â”‚                â”‚
    â”‚                      â”‚                   â”‚                â”‚
    â”‚                      â”‚â”€validate_authority()â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
    â”‚                      â”‚                   â”‚                â”‚
    â”‚                      â”‚â”€create_mint()â”€â”€â”€â”€â”€â–ºâ”‚                â”‚
    â”‚                      â”‚  (decimals: 6)    â”‚                â”‚
    â”‚                      â”‚                   â”‚                â”‚
    â”‚                      â”‚â—„â”€mint_createdâ”€â”€â”€â”€â”€â”‚                â”‚
    â”‚                      â”‚                   â”‚                â”‚
    â”‚                      â”‚â”€update_token_info()â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
    â”‚                      â”‚â”€emit_event()â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
    â”‚                      â”‚                   â”‚                â”‚
    â”‚â—„â”€token_readyâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                   â”‚                â”‚
    â”‚                      â”‚                   â”‚                â”‚
```

### Energy-Token.transfer_tokens() Sequence

```
User/System       EnergyTokenProgram  SPLTokenProgram     Blockchain
    â”‚                     â”‚                   â”‚                â”‚
    â”‚â”€â”€transfer_tokens()â”€â”€â”€â–ºâ”‚                   â”‚                â”‚
    â”‚  (amount, recipient) â”‚                   â”‚                â”‚
    â”‚                      â”‚                   â”‚                â”‚
    â”‚                      â”‚â”€validate_amount()â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
    â”‚                      â”‚                   â”‚                â”‚
    â”‚                      â”‚â”€get_token_account()â–ºâ”‚               â”‚
    â”‚                      â”‚                   â”‚â”€create_if_neededâ”‚
    â”‚                      â”‚                   â”‚â—„â”€account_readyâ”€â”‚
    â”‚                      â”‚â—„â”€account_existsâ”€â”€â”€â”‚                â”‚
    â”‚                      â”‚                   â”‚                â”‚
    â”‚                      â”‚â”€mint_to()â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                â”‚
    â”‚                      â”‚                   â”‚â”€mint_tokens()â”€â”€â–ºâ”‚
    â”‚                      â”‚                   â”‚â—„â”€tokens_mintedâ”€â”‚
    â”‚                      â”‚â—„â”€transfer_completeâ”‚                â”‚
    â”‚                      â”‚                   â”‚                â”‚
    â”‚                      â”‚â”€update_supply()â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
    â”‚                      â”‚â”€emit_event()â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
    â”‚                      â”‚                   â”‚                â”‚
    â”‚â—„â”€tokens_transferredâ”€â”€â”‚                   â”‚                â”‚
    â”‚                      â”‚                   â”‚                â”‚
```

### Energy-Token.burn_tokens() Sequence

```
User              EnergyTokenProgram  SPLTokenProgram     Blockchain
    â”‚                     â”‚                   â”‚                â”‚
    â”‚â”€â”€burn_tokens()â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                   â”‚                â”‚
    â”‚  (amount)            â”‚                   â”‚                â”‚
    â”‚                      â”‚                   â”‚                â”‚
    â”‚                      â”‚â”€validate_balance()â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
    â”‚                      â”‚â”€validate_amount()â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
    â”‚                      â”‚                   â”‚                â”‚
    â”‚                      â”‚â”€burn_from()â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                â”‚
    â”‚                      â”‚                   â”‚â”€burn_tokens()â”€â”€â–ºâ”‚
    â”‚                      â”‚                   â”‚â—„â”€tokens_burnedâ”€â”‚
    â”‚                      â”‚â—„â”€burn_completeâ”€â”€â”€â”€â”‚                â”‚
    â”‚                      â”‚                   â”‚                â”‚
    â”‚                      â”‚â”€update_supply()â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
    â”‚                      â”‚â”€emit_event()â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
    â”‚                      â”‚                   â”‚                â”‚
    â”‚â—„â”€tokens_burnedâ”€â”€â”€â”€â”€â”€â”€â”‚                   â”‚                â”‚
    â”‚                      â”‚                   â”‚                â”‚
```

---

## Trading Program Sequences

### Trading.initialize_market() Sequence

```
Authority         TradingProgram      SystemProgram       Blockchain
    â”‚                     â”‚                   â”‚                â”‚
    â”‚â”€â”€initialize_market()â”€â–ºâ”‚                   â”‚                â”‚
    â”‚                      â”‚                   â”‚                â”‚
    â”‚                      â”‚â”€validate_authority()â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
    â”‚                      â”‚                   â”‚                â”‚
    â”‚                      â”‚â”€create_market_pda()â–ºâ”‚               â”‚
    â”‚                      â”‚  [seed: "market"]  â”‚                â”‚
    â”‚                      â”‚                   â”‚                â”‚
    â”‚                      â”‚â—„â”€market_createdâ”€â”€â”€â”‚                â”‚
    â”‚                      â”‚                   â”‚                â”‚
    â”‚                      â”‚â”€set_market_config()â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
    â”‚                      â”‚â”€set_trading_fee()â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
    â”‚                      â”‚â”€emit_event()â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
    â”‚                      â”‚                   â”‚                â”‚
    â”‚â—„â”€market_readyâ”€â”€â”€â”€â”€â”€â”€â”€â”‚                   â”‚                â”‚
    â”‚                      â”‚                   â”‚                â”‚
```

### Trading.create_sell_order() Sequence

```
Seller            TradingProgram      SPLTokenProgram     Blockchain
    â”‚                     â”‚                   â”‚                â”‚
    â”‚â”€â”€create_sell_order()â”€â–ºâ”‚                   â”‚                â”‚
    â”‚  (amount, price)     â”‚                   â”‚                â”‚
    â”‚                      â”‚                   â”‚                â”‚
    â”‚                      â”‚â”€validate_user()â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
    â”‚                      â”‚â”€validate_amount()â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
    â”‚                      â”‚â”€check_balance()â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
    â”‚                      â”‚                   â”‚                â”‚
    â”‚                      â”‚â”€transfer_escrow()â”€â–ºâ”‚                â”‚
    â”‚                      â”‚                   â”‚â”€transfer_tokens()â”‚
    â”‚                      â”‚                   â”‚â—„â”€tokens_escrowedâ”‚
    â”‚                      â”‚â—„â”€escrow_completeâ”€â”€â”‚                â”‚
    â”‚                      â”‚                   â”‚                â”‚
    â”‚                      â”‚â”€create_order()â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
    â”‚                      â”‚â”€update_market()â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
    â”‚                      â”‚â”€emit_event()â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
    â”‚                      â”‚                   â”‚                â”‚
    â”‚â—„â”€order_createdâ”€â”€â”€â”€â”€â”€â”€â”‚                   â”‚                â”‚
    â”‚                      â”‚                   â”‚                â”‚
```

### Trading.create_buy_order() Sequence

```
Buyer             TradingProgram      SPLTokenProgram     Blockchain
    â”‚                     â”‚                   â”‚                â”‚
    â”‚â”€â”€create_buy_order()â”€â”€â–ºâ”‚                   â”‚                â”‚
    â”‚  (amount, max_price) â”‚                   â”‚                â”‚
    â”‚                      â”‚                   â”‚                â”‚
    â”‚                      â”‚â”€validate_user()â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
    â”‚                      â”‚â”€validate_amount()â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
    â”‚                      â”‚â”€calculate_escrow()â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
    â”‚                      â”‚â”€check_balance()â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
    â”‚                      â”‚                   â”‚                â”‚
    â”‚                      â”‚â”€transfer_escrow()â”€â–ºâ”‚                â”‚
    â”‚                      â”‚                   â”‚â”€transfer_tokens()â”‚
    â”‚                      â”‚                   â”‚â—„â”€tokens_escrowedâ”‚
    â”‚                      â”‚â—„â”€escrow_completeâ”€â”€â”‚                â”‚
    â”‚                      â”‚                   â”‚                â”‚
    â”‚                      â”‚â”€create_order()â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
    â”‚                      â”‚â”€update_market()â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
    â”‚                      â”‚â”€emit_event()â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
    â”‚                      â”‚                   â”‚                â”‚
    â”‚â—„â”€order_createdâ”€â”€â”€â”€â”€â”€â”€â”‚                   â”‚                â”‚
    â”‚                      â”‚                   â”‚                â”‚
```

### Trading.match_orders() Sequence

```
MarketMaker       TradingProgram      SPLTokenProgram     Blockchain
    â”‚                     â”‚                   â”‚                â”‚
    â”‚â”€â”€match_orders()â”€â”€â”€â”€â”€â”€â–ºâ”‚                   â”‚                â”‚
    â”‚                      â”‚                   â”‚                â”‚
    â”‚                      â”‚â”€find_orders()â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
    â”‚                      â”‚â”€validate_match()â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
    â”‚                      â”‚â”€calculate_trade()â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
    â”‚                      â”‚                   â”‚                â”‚
    â”‚                      â”‚â”€transfer_energy()â”€â–ºâ”‚                â”‚
    â”‚                      â”‚  (to buyer)       â”‚â”€transfer_tokens()â”‚
    â”‚                      â”‚                   â”‚â—„â”€energy_transferredâ”‚
    â”‚                      â”‚â—„â”€transfer_1â”€â”€â”€â”€â”€â”€â”€â”‚                â”‚
    â”‚                      â”‚                   â”‚                â”‚
    â”‚                      â”‚â”€transfer_payment()â–ºâ”‚                â”‚
    â”‚                      â”‚  (to seller)      â”‚â”€transfer_tokens()â”‚
    â”‚                      â”‚                   â”‚â—„â”€payment_transferredâ”‚
    â”‚                      â”‚â—„â”€transfer_2â”€â”€â”€â”€â”€â”€â”€â”‚                â”‚
    â”‚                      â”‚                   â”‚                â”‚
    â”‚                      â”‚â”€transfer_fee()â”€â”€â”€â”€â–ºâ”‚                â”‚
    â”‚                      â”‚  (to market)      â”‚â”€transfer_tokens()â”‚
    â”‚                      â”‚                   â”‚â—„â”€fee_transferredâ”‚
    â”‚                      â”‚â—„â”€transfer_3â”€â”€â”€â”€â”€â”€â”€â”‚                â”‚
    â”‚                      â”‚                   â”‚                â”‚
    â”‚                      â”‚â”€update_orders()â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
    â”‚                      â”‚â”€create_trade()â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
    â”‚                      â”‚â”€update_market()â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
    â”‚                      â”‚â”€emit_event()â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
    â”‚                      â”‚                   â”‚                â”‚
    â”‚â—„â”€trade_executedâ”€â”€â”€â”€â”€â”€â”‚                   â”‚                â”‚
    â”‚                      â”‚                   â”‚                â”‚
```

### Trading.cancel_order() Sequence

```
User              TradingProgram      SPLTokenProgram     Blockchain
    â”‚                     â”‚                   â”‚                â”‚
    â”‚â”€â”€cancel_order()â”€â”€â”€â”€â”€â”€â–ºâ”‚                   â”‚                â”‚
    â”‚  (order_id)          â”‚                   â”‚                â”‚
    â”‚                      â”‚                   â”‚                â”‚
    â”‚                      â”‚â”€validate_owner()â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
    â”‚                      â”‚â”€check_cancellable()â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
    â”‚                      â”‚                   â”‚                â”‚
    â”‚                      â”‚â”€return_escrow()â”€â”€â”€â–ºâ”‚                â”‚
    â”‚                      â”‚                   â”‚â”€transfer_tokens()â”‚
    â”‚                      â”‚                   â”‚â—„â”€tokens_returnedâ”‚
    â”‚                      â”‚â—„â”€escrow_returnedâ”€â”€â”‚                â”‚
    â”‚                      â”‚                   â”‚                â”‚
    â”‚                      â”‚â”€update_order()â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
    â”‚                      â”‚â”€emit_event()â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
    â”‚                      â”‚                   â”‚                â”‚
    â”‚â—„â”€order_cancelledâ”€â”€â”€â”€â”€â”‚                   â”‚                â”‚
    â”‚                      â”‚                   â”‚                â”‚
```

---

## End-to-End Business Sequences

### Complete Energy Generation to Trading Sequence

```
Physical     AMI      APIGateway   Oracle    Registry   Governance   EnergyToken   Trading    Users
   â”‚          â”‚           â”‚          â”‚         â”‚           â”‚            â”‚           â”‚         â”‚
   â”‚â”€generateâ”€â–ºâ”‚           â”‚          â”‚         â”‚           â”‚            â”‚           â”‚         â”‚
   â”‚ 100kWh   â”‚           â”‚          â”‚         â”‚           â”‚            â”‚           â”‚         â”‚
   â”‚          â”‚â”€readingâ”€â”€â”€â–ºâ”‚          â”‚         â”‚           â”‚            â”‚           â”‚         â”‚
   â”‚          â”‚           â”‚â”€submitâ”€â”€â”€â–ºâ”‚         â”‚           â”‚            â”‚           â”‚         â”‚
   â”‚          â”‚           â”‚          â”‚â”€updateâ”€â”€â–ºâ”‚           â”‚            â”‚           â”‚         â”‚
   â”‚          â”‚           â”‚          â”‚         â”‚â”€triggerâ”€â”€â”€â–ºâ”‚            â”‚           â”‚         â”‚
   â”‚          â”‚           â”‚          â”‚         â”‚           â”‚â”€issue_ercâ”€â”€â–ºâ”‚           â”‚         â”‚
   â”‚          â”‚           â”‚          â”‚         â”‚           â”‚â—„â”€erc_issuedâ”€â”‚           â”‚         â”‚
   â”‚          â”‚           â”‚          â”‚         â”‚           â”‚â”€validateâ”€â”€â”€â–ºâ”‚           â”‚         â”‚
   â”‚          â”‚           â”‚          â”‚         â”‚           â”‚â”€triggerâ”€â”€â”€â”€â”€â–ºâ”‚           â”‚         â”‚
   â”‚          â”‚           â”‚          â”‚         â”‚           â”‚             â”‚â”€transferâ”€â”€â–ºâ”‚         â”‚
   â”‚          â”‚           â”‚          â”‚         â”‚           â”‚             â”‚â—„â”€tokensâ”€â”€â”€â”‚         â”‚
   â”‚          â”‚           â”‚          â”‚         â”‚           â”‚             â”‚           â”‚â—„â”€readyâ”€â”€â”‚
   â”‚          â”‚           â”‚          â”‚         â”‚           â”‚             â”‚           â”‚â”€createâ”€â”€â–ºâ”‚
   â”‚          â”‚           â”‚          â”‚         â”‚           â”‚             â”‚           â”‚ sell     â”‚
   â”‚          â”‚           â”‚          â”‚         â”‚           â”‚             â”‚           â”‚â—„â”€orderâ”€â”€â”€â”‚
   â”‚          â”‚           â”‚          â”‚         â”‚           â”‚             â”‚           â”‚         â”‚
   â”‚          â”‚           â”‚          â”‚         â”‚           â”‚             â”‚           â”‚â—„â”€buyâ”€â”€â”€â”€â”€â”‚
   â”‚          â”‚           â”‚          â”‚         â”‚           â”‚             â”‚           â”‚ order    â”‚
   â”‚          â”‚           â”‚          â”‚         â”‚           â”‚             â”‚           â”‚         â”‚
   â”‚          â”‚           â”‚â”€triggerâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚         â”‚
   â”‚          â”‚           â”‚ clearing â”‚         â”‚           â”‚             â”‚           â”‚         â”‚
   â”‚          â”‚           â”‚          â”‚         â”‚           â”‚             â”‚           â”‚â”€matchâ”€â”€â”€â”€â–ºâ”‚
   â”‚          â”‚           â”‚          â”‚         â”‚           â”‚             â”‚           â”‚ orders   â”‚
   â”‚          â”‚           â”‚          â”‚         â”‚           â”‚             â”‚           â”‚â—„â”€tradeâ”€â”€â”€â”‚
   â”‚          â”‚           â”‚          â”‚         â”‚           â”‚             â”‚           â”‚ complete â”‚
   â”‚          â”‚           â”‚          â”‚         â”‚           â”‚             â”‚           â”‚         â”‚
```

### User Onboarding and First Trade Sequence

```
NewUser      Registry    Oracle    Governance   EnergyToken   Trading    Blockchain
   â”‚             â”‚          â”‚          â”‚            â”‚           â”‚            â”‚
   â”‚â”€registerâ”€â”€â”€â”€â–ºâ”‚          â”‚          â”‚            â”‚           â”‚            â”‚
   â”‚ user        â”‚â”€createâ”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
   â”‚             â”‚ account  â”‚          â”‚            â”‚           â”‚            â”‚
   â”‚â—„â”€registeredâ”€â”‚          â”‚          â”‚            â”‚           â”‚            â”‚
   â”‚             â”‚          â”‚          â”‚            â”‚           â”‚            â”‚
   â”‚â”€registerâ”€â”€â”€â”€â–ºâ”‚          â”‚          â”‚            â”‚           â”‚            â”‚
   â”‚ meter       â”‚â”€createâ”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
   â”‚             â”‚ meter    â”‚          â”‚            â”‚           â”‚            â”‚
   â”‚â—„â”€meter_readyâ”‚          â”‚          â”‚            â”‚           â”‚            â”‚
   â”‚             â”‚          â”‚          â”‚            â”‚           â”‚            â”‚
   â”‚â”€generateâ”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚          â”‚            â”‚           â”‚            â”‚
   â”‚ energy      â”‚          â”‚â”€readingâ”€â”€â–ºâ”‚            â”‚           â”‚            â”‚
   â”‚             â”‚          â”‚          â”‚â”€issue_ercâ”€â”€â–ºâ”‚           â”‚            â”‚
   â”‚             â”‚          â”‚          â”‚â—„â”€ercâ”€â”€â”€â”€â”€â”€â”€â”‚           â”‚            â”‚
   â”‚             â”‚          â”‚          â”‚â”€validateâ”€â”€â”€â–ºâ”‚           â”‚            â”‚
   â”‚             â”‚          â”‚          â”‚â”€triggerâ”€â”€â”€â”€â”€â–ºâ”‚           â”‚            â”‚
   â”‚             â”‚          â”‚          â”‚             â”‚â”€transferâ”€â”€â–ºâ”‚            â”‚
   â”‚â—„â”€tokensâ”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚â—„â”€tokensâ”€â”€â”€â”‚            â”‚
   â”‚ received    â”‚          â”‚          â”‚             â”‚           â”‚            â”‚
   â”‚             â”‚          â”‚          â”‚             â”‚           â”‚            â”‚
   â”‚â”€createâ”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚            â”‚
   â”‚ sell_order  â”‚          â”‚          â”‚             â”‚           â”‚â”€escrowâ”€â”€â”€â”€â”€â–ºâ”‚
   â”‚â—„â”€orderâ”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚â—„â”€orderâ”€â”€â”€â”€â”€â”‚
   â”‚ created     â”‚          â”‚          â”‚             â”‚           â”‚ created    â”‚
   â”‚             â”‚          â”‚          â”‚             â”‚           â”‚            â”‚
```

---

## Emergency Response Sequences

### Emergency Pause Activation Sequence

```
Monitor      Authority    Governance   Oracle    Registry   EnergyToken   Trading   
   â”‚             â”‚            â”‚          â”‚         â”‚           â”‚            â”‚       
   â”‚â”€detectâ”€â”€â”€â”€â”€â”€â–ºâ”‚            â”‚          â”‚         â”‚           â”‚            â”‚       
   â”‚ threat      â”‚            â”‚          â”‚         â”‚           â”‚            â”‚       
   â”‚             â”‚â”€emergencyâ”€â”€â”€â–ºâ”‚          â”‚         â”‚           â”‚            â”‚       
   â”‚             â”‚ pause       â”‚â”€pauseâ”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚       
   â”‚             â”‚             â”‚          â”‚         â”‚           â”‚            â”‚       
   â”‚             â”‚             â”‚â”€notifyâ”€â”€â”€â–ºâ”‚         â”‚           â”‚            â”‚       
   â”‚             â”‚             â”‚          â”‚â”€disableâ”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚       
   â”‚             â”‚             â”‚          â”‚         â”‚           â”‚            â”‚       
   â”‚             â”‚             â”‚â”€notifyâ”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚           â”‚            â”‚       
   â”‚             â”‚             â”‚          â”‚         â”‚â”€disableâ”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚       
   â”‚             â”‚             â”‚          â”‚         â”‚           â”‚            â”‚       
   â”‚             â”‚             â”‚â”€notifyâ”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚            â”‚       
   â”‚             â”‚             â”‚          â”‚         â”‚           â”‚â”€disableâ”€â”€â”€â”€â–ºâ”‚       
   â”‚             â”‚             â”‚          â”‚         â”‚           â”‚            â”‚       
   â”‚             â”‚             â”‚â”€notifyâ”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚       
   â”‚             â”‚             â”‚          â”‚         â”‚           â”‚            â”‚â”€blockâ”€
   â”‚             â”‚             â”‚          â”‚         â”‚           â”‚            â”‚ all   
   â”‚â—„â”€systemâ”€â”€â”€â”€â”€â”‚â—„â”€emergencyâ”€â”€â”‚â—„â”€pausedâ”€â”€â”‚â—„â”€pausedâ”€â”‚â—„â”€pausedâ”€â”€â”€â”‚â—„â”€pausedâ”€â”€â”€â”€â”‚â—„â”€funcs
   â”‚ frozen      â”‚ active      â”‚          â”‚         â”‚           â”‚            â”‚       
   â”‚             â”‚             â”‚          â”‚         â”‚           â”‚            â”‚       
```

### Emergency Recovery Sequence

```
Monitor      Authority    Governance   Oracle    Registry   EnergyToken   Trading   
   â”‚             â”‚            â”‚          â”‚         â”‚           â”‚            â”‚       
   â”‚â”€threatâ”€â”€â”€â”€â”€â”€â–ºâ”‚            â”‚          â”‚         â”‚           â”‚            â”‚       
   â”‚ resolved    â”‚            â”‚          â”‚         â”‚           â”‚            â”‚       
   â”‚             â”‚â”€emergencyâ”€â”€â”€â–ºâ”‚          â”‚         â”‚           â”‚            â”‚       
   â”‚             â”‚ unpause     â”‚â”€unpauseâ”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚       
   â”‚             â”‚             â”‚          â”‚         â”‚           â”‚            â”‚       
   â”‚             â”‚             â”‚â”€enableâ”€â”€â”€â–ºâ”‚         â”‚           â”‚            â”‚       
   â”‚             â”‚             â”‚          â”‚â”€enableâ”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚       
   â”‚             â”‚             â”‚          â”‚         â”‚           â”‚            â”‚       
   â”‚             â”‚             â”‚â”€enableâ”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚           â”‚            â”‚       
   â”‚             â”‚             â”‚          â”‚         â”‚â”€enableâ”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚       
   â”‚             â”‚             â”‚          â”‚         â”‚           â”‚            â”‚       
   â”‚             â”‚             â”‚â”€enableâ”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚            â”‚       
   â”‚             â”‚             â”‚          â”‚         â”‚           â”‚â”€enableâ”€â”€â”€â”€â”€â–ºâ”‚       
   â”‚             â”‚             â”‚          â”‚         â”‚           â”‚            â”‚       
   â”‚             â”‚             â”‚â”€enableâ”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚       
   â”‚             â”‚             â”‚          â”‚         â”‚           â”‚            â”‚â”€resume
   â”‚â—„â”€systemâ”€â”€â”€â”€â”€â”‚â—„â”€normalâ”€â”€â”€â”€â”€â”‚â—„â”€resumedâ”€â”‚â—„â”€resumedâ”‚â—„â”€resumedâ”€â”€â”‚â—„â”€resumedâ”€â”€â”€â”‚â—„â”€funcs
   â”‚ normal      â”‚ operations  â”‚          â”‚         â”‚           â”‚            â”‚       
   â”‚             â”‚             â”‚          â”‚         â”‚           â”‚            â”‚       
```

### Order Expiration Cleanup Sequence

```
Scheduler    TradingProgram    SPLTokenProgram    Users    Blockchain
    â”‚              â”‚                 â”‚            â”‚          â”‚
    â”‚â”€checkâ”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                 â”‚            â”‚          â”‚
    â”‚ expired      â”‚                 â”‚            â”‚          â”‚
    â”‚              â”‚â”€find_expired()â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
    â”‚              â”‚                 â”‚            â”‚          â”‚
    â”‚              â”‚â”€validate_time()â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
    â”‚              â”‚                 â”‚            â”‚          â”‚
    â”‚              â”‚â”€return_escrow()â”€â–ºâ”‚            â”‚          â”‚
    â”‚              â”‚                 â”‚â”€transferâ”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
    â”‚              â”‚                 â”‚ tokens     â”‚          â”‚
    â”‚              â”‚â—„â”€escrow_returnâ”€â”€â”‚            â”‚          â”‚
    â”‚              â”‚                 â”‚            â”‚          â”‚
    â”‚              â”‚â”€update_status()â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
    â”‚              â”‚ (Expired)       â”‚            â”‚          â”‚
    â”‚              â”‚                 â”‚            â”‚          â”‚
    â”‚              â”‚â”€emit_event()â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
    â”‚              â”‚ OrderExpired    â”‚            â”‚          â”‚
    â”‚              â”‚                 â”‚            â”‚          â”‚
    â”‚              â”‚â”€notify_user()â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚          â”‚
    â”‚              â”‚                 â”‚            â”‚â—„â”€notifiedâ”‚
    â”‚â—„â”€cleanupâ”€â”€â”€â”€â”€â”‚                 â”‚            â”‚          â”‚
    â”‚ complete     â”‚                 â”‚            â”‚          â”‚
    â”‚              â”‚                 â”‚            â”‚          â”‚
```

### Market Clearing Automation Sequence

```
Scheduler    APIGateway    Oracle    Trading    SPLToken    Blockchain
    â”‚            â”‚           â”‚         â”‚           â”‚           â”‚
    â”‚â”€triggerâ”€â”€â”€â”€â”€â–ºâ”‚           â”‚         â”‚           â”‚           â”‚
    â”‚ clearing    â”‚           â”‚         â”‚           â”‚           â”‚
    â”‚             â”‚â”€clearingâ”€â”€â–ºâ”‚         â”‚           â”‚           â”‚
    â”‚             â”‚           â”‚â”€triggerâ”€â–ºâ”‚           â”‚           â”‚
    â”‚             â”‚           â”‚         â”‚â”€findâ”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
    â”‚             â”‚           â”‚         â”‚ matches   â”‚           â”‚
    â”‚             â”‚           â”‚         â”‚           â”‚           â”‚
    â”‚             â”‚           â”‚         â”‚â”€executeâ”€â”€â”€â–ºâ”‚           â”‚
    â”‚             â”‚           â”‚         â”‚ trades    â”‚â”€transfersâ”€â–ºâ”‚
    â”‚             â”‚           â”‚         â”‚           â”‚â—„â”€completeâ”€â”‚
    â”‚             â”‚           â”‚         â”‚â—„â”€tradesâ”€â”€â”€â”‚           â”‚
    â”‚             â”‚           â”‚         â”‚ executed  â”‚           â”‚
    â”‚             â”‚           â”‚â—„â”€marketâ”€â”‚           â”‚           â”‚
    â”‚             â”‚           â”‚ cleared â”‚           â”‚           â”‚
    â”‚             â”‚â—„â”€successâ”€â”€â”‚         â”‚           â”‚           â”‚
    â”‚â—„â”€clearingâ”€â”€â”€â”‚           â”‚         â”‚           â”‚           â”‚
    â”‚ complete    â”‚           â”‚         â”‚           â”‚           â”‚
    â”‚             â”‚           â”‚         â”‚           â”‚           â”‚
```

---

**Key Sequence Patterns:**

1. **Initialization Sequences**: System setup with authority validation
2. **CPI Sequences**: Cross-program calls with proper authorization
3. **User Interaction Sequences**: Direct user function calls with validation
4. **Error Recovery Sequences**: Rollback and cleanup procedures
5. **Emergency Sequences**: System-wide pause and recovery operations
6. **Automation Sequences**: Scheduled operations and cleanup tasks

---

**[â† Back to Architecture Overview](./README.md)**