%% Market Clearing Engine Architecture Diagram
%% Render this diagram using Mermaid: https://mermaid.live

graph TB
    subgraph "Client Layer"
        WEB[Web Frontend]
        MOBILE[Mobile App]
        API_CLIENT[API Clients]
    end

    subgraph "API Gateway"
        subgraph "HTTP Handlers"
            TRADING_H[Trading Handler]
            MARKET_H[Market Handler]
            ADMIN_H[Admin Handler]
        end
        
        subgraph "Core Services"
            MCE[Market Clearing Engine]
            SETTLE[Settlement Service]
            WS_SVC[WebSocket Service]
        end
        
        subgraph "Order Book"
            OB_BUY[Buy Orders<br/>BTreeMap DESC]
            OB_SELL[Sell Orders<br/>BTreeMap ASC]
            OB_INDEX[Order Index<br/>HashMap]
        end
    end

    subgraph "Matching Engine"
        LOOP[Continuous Loop<br/>1000ms interval]
        MATCH_ALGO[Matching Algorithm<br/>Price-Time Priority]
        PARTIAL[Partial Fill Handler]
    end

    subgraph "Data Layer"
        POSTGRES[(PostgreSQL<br/>Trade History)]
        REDIS[(Redis<br/>Order Book Snapshots)]
    end

    subgraph "Blockchain"
        SOLANA[Solana Network<br/>Energy Token Transfers]
    end

    %% Client connections
    WEB -->|REST API| TRADING_H
    WEB -->|WebSocket| WS_SVC
    MOBILE -->|REST API| TRADING_H
    API_CLIENT -->|REST API| MARKET_H
    API_CLIENT -->|Admin API| ADMIN_H

    %% Handler to Services
    TRADING_H -->|Create/Cancel Order| MCE
    MARKET_H -->|Query Data| MCE
    ADMIN_H -->|Control/Analytics| MCE

    %% Market Clearing Engine
    MCE -->|Manage| OB_BUY
    MCE -->|Manage| OB_SELL
    MCE -->|Lookup| OB_INDEX
    MCE -->|Trigger| LOOP
    MCE -->|Broadcast Updates| WS_SVC

    %% Matching Loop
    LOOP -->|Read Orders| OB_BUY
    LOOP -->|Read Orders| OB_SELL
    LOOP -->|Execute| MATCH_ALGO
    MATCH_ALGO -->|Create| PARTIAL
    PARTIAL -->|Update| OB_BUY
    PARTIAL -->|Update| OB_SELL
    PARTIAL -->|Generate| TRADE[Trade Match]

    %% Settlement
    TRADE -->|Submit| SETTLE
    SETTLE -->|Execute Transaction| SOLANA
    SETTLE -->|Record| POSTGRES

    %% Persistence
    MCE -->|Snapshot| REDIS
    MCE -->|Log Trades| POSTGRES
    REDIS -->|Restore on Startup| MCE

    %% WebSocket Broadcasting
    WS_SVC -->|Market Data| WEB
    WS_SVC -->|Market Data| MOBILE

    style MCE fill:#4CAF50,stroke:#333,stroke-width:3px,color:#fff
    style MATCH_ALGO fill:#2196F3,stroke:#333,stroke-width:2px,color:#fff
    style SETTLE fill:#FF9800,stroke:#333,stroke-width:2px,color:#fff
    style SOLANA fill:#9C27B0,stroke:#333,stroke-width:2px,color:#fff
