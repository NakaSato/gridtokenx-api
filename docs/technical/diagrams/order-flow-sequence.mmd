%% Order Flow Sequence Diagram
%% Render this diagram using Mermaid: https://mermaid.live

sequenceDiagram
    participant User
    participant API as API Handler
    participant MCE as Market Clearing Engine
    participant OB as Order Book
    participant Redis
    participant DB as PostgreSQL
    participant WS as WebSocket Service
    participant Matcher as Matching Engine
    participant Settlement as Settlement Service
    participant Solana as Blockchain

    %% Order Placement Flow
    User->>API: POST /api/trading/orders<br/>{side: Buy, amount: 100, price: 0.15}
    activate API
    
    API->>API: Validate request
    Note over API: Check amount > 0<br/>Check price > 0<br/>Verify auth
    
    API->>DB: INSERT order (status: Pending)
    activate DB
    DB-->>API: Order ID
    deactivate DB
    
    API->>MCE: Add order to book
    activate MCE
    
    MCE->>OB: Insert into buy/sell levels
    activate OB
    OB->>OB: Update price level<br/>Update total volume
    OB-->>MCE: Order added
    deactivate OB
    
    MCE->>Redis: Persist order<br/>ZADD, HSET, EXPIRE
    activate Redis
    Redis-->>MCE: OK
    deactivate Redis
    
    MCE->>WS: Broadcast order book update
    activate WS
    WS-->>User: Order book changed
    deactivate WS
    
    MCE-->>API: Order accepted
    deactivate MCE
    API-->>User: 201 Created<br/>{order_id, status}
    deactivate API

    %% Matching Loop
    Note over Matcher: Continuous loop<br/>every 1000ms
    
    Matcher->>OB: Get best bid & ask
    activate OB
    OB-->>Matcher: Bid: $0.20, Ask: $0.18
    deactivate OB
    
    Matcher->>Matcher: Check if bid >= ask
    Note over Matcher: Match possible!<br/>$0.20 >= $0.18
    
    Matcher->>OB: Execute match<br/>quantity: min(100, 50) = 50
    activate OB
    
    OB->>OB: Update filled amounts<br/>Remove filled orders
    OB-->>Matcher: Trade created
    deactivate OB
    
    Matcher->>DB: Record trade
    activate DB
    DB-->>Matcher: Trade ID
    deactivate DB
    
    Matcher->>WS: Broadcast trade execution
    activate WS
    WS-->>User: Trade executed
    deactivate WS

    %% Settlement Flow
    Matcher->>Settlement: Submit trade for settlement
    activate Settlement
    
    Settlement->>Settlement: Calculate fees<br/>fee = 50 × 0.18 × 0.001
    
    Settlement->>DB: Create settlement record<br/>(status: Pending)
    activate DB
    DB-->>Settlement: Settlement ID
    deactivate DB
    
    Settlement->>Solana: Submit transaction<br/>Transfer energy tokens
    activate Solana
    Note over Settlement: Status: Processing
    
    Solana-->>Settlement: Transaction signature
    
    Settlement->>Solana: Wait for confirmation<br/>(max 30 seconds)
    Solana-->>Settlement: Confirmed
    deactivate Solana
    
    Settlement->>DB: Update status: Confirmed
    activate DB
    DB-->>Settlement: Updated
    deactivate DB
    
    Settlement->>WS: Notify settlement complete
    activate WS
    WS-->>User: Settlement confirmed
    deactivate WS
    
    Settlement-->>Matcher: Settlement successful
    deactivate Settlement

    %% User Query
    User->>API: GET /api/market/trades/my-history
    activate API
    
    API->>DB: Query trades<br/>WHERE user_id = ?
    activate DB
    DB-->>API: Trade records
    deactivate DB
    
    API-->>User: 200 OK<br/>[{trade_id, quantity, price, status}]
    deactivate API
