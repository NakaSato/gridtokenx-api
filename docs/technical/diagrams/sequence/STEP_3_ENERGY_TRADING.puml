@startuml STEP_3_ENERGY_TRADING
!define AWSPUML https://raw.githubusercontent.com/awslabs/aws-icons-for-plantuml/v14.0/dist
!include AWSPUML/AWSCommon.puml
!include AWSPUML/SecurityIdentityCompliance/IdentityandAccessManagement.puml
!include AWSPUML/Database/RDS.puml

title Step 3: Energy Trading (15-min Epochs) Flow\n<size:11>Peer-to-Peer Energy Trading and Order Matching Process</size>

skinparam backgroundColor #f8f9fa
skinparam RoundCornerSpacing 10
skinparam DefaultFontName Helvetica
skinparam DefaultFontSize 12
skinparam ArrowFontSize 11
skinparam NoteFontSize 11
skinparam ParticipantFontSize 12
skinparam ParticipantFontStyle bold
skinparam ActorFontSize 12
skinparam ActorFontStyle bold
skinparam SequenceMessageAlign center
skinparam BoxPadding 10
skinparam ParticipantPadding 20
skinparam SequenceBoxBorderColor #888888
skinparam NoteBorderColor #4CAF50
skinparam NoteBackgroundColor #E8F5E9

skinparam NoteBorderColor #4CAF50
skinparam NoteBackgroundColor #E8F5E9

actor "Seller\n(Prosumer)" as Seller #C8E6C9
actor "Buyer\n(Consumer)" as Buyer #BBDEFB
participant "API Gateway\n(Rust/Axum)" as API #E1F5FE
participant "Trading Program\n(Anchor/Solana)" as Trading #FFCCBC
database "PostgreSQL\nOrders Table" as OrderDB #FFF9C4
participant "Energy Token\nProgram (SPL)" as TokenProgram #E1BEE7
participant "Registry Program\n(Anchor/Solana)" as Registry #C8E6C9
participant "Solana Blockchain\n(PoA Validator)" as Blockchain #F8BBD0

== Trading Epoch: 0:00-0:15 ==

note over Seller, Buyer
  15-minute trading window for order placement
  Orders collect in order book
end note

== Seller Creates Sell Order ==

Seller -> API: POST /create-order\n{\n  order_type: \"sell\",\n  energy_amount: 2.5,\n  price_per_unit: 0.05,\n  expiry: epoch_end\n}

activate API

note right of API
  <b>API Validation:</b>
  * Verify user is authenticated
  * Validate order parameters
  * Check user token balance
  
  <i>JWT authentication required</i>
end note

API -> Registry: Verify seller status\nget_user(seller_wallet)
activate Registry

note right of Registry
  <b>Registry Program:</b>
  * Lookup user account
  * Verify registration status
  * Return user type (student/faculty)
  
  <i>On-chain identity verification</i>
end note

Registry --> API: User verified (check)\n(user_type: student)
deactivate Registry

API -> TokenProgram: Check balance\nget_balance(seller_ata)
activate TokenProgram

note right of TokenProgram
  <b>SPL Token Program:</b>
  * Query Associated Token Account
  * Return current balance
  
  <i>Verify seller has sufficient tokens</i>
end note

TokenProgram --> API: Balance: 2,500,000,000 tokens (check)\n(2.5 kWh equivalent)
deactivate TokenProgram

API -> Trading: create_sell_order()\n{\n  seller: seller_wallet,\n  energy_amount: 2,500,000,000,\n  price_per_unit: 0.05,\n  status: \"pending\"\n}

activate Trading

note right of Trading
  <b>Trading Program Instruction:</b>
  * Create order account PDA
  * Store order parameters
  * Set initial status = pending
  * Lock tokens in escrow (optional)
  
  <i>Order stored on-chain for transparency</i>
end note

Trading -> Blockchain: Execute on-chain\ncreate_sell_order instruction
activate Blockchain
Blockchain --> Trading: Order created (check)\norder_id: SELL_001
deactivate Blockchain

Trading --> API: Order confirmed
deactivate Trading

API -> OrderDB: Insert order record\n{\n  order_id: SELL_001,\n  seller_wallet,\n  order_type: \"sell\",\n  energy: 2.5,\n  price: 0.05,\n  status: \"pending\",\n  created_at: timestamp\n}

activate OrderDB
OrderDB --> API: Order persisted (check)
deactivate OrderDB

API --> Seller: 201 Created\n{\n  order_id: SELL_001,\n  status: \"pending\",\n  available_for_matching\n}
deactivate API

note over Seller
  <b>Sell Order Placed</b>
  Seller's order is now in the order book
  Waiting for buyer match
end note

== Buyer Creates Buy Order ==

Buyer -> API: POST /create-order\n{\n  order_type: \"buy\",\n  energy_amount: 2.5,\n  price_per_unit: 0.05,\n  expiry: epoch_end\n}

activate API

API -> Registry: Verify buyer status\nget_user(buyer_wallet)
activate Registry
Registry --> API: User verified (check)\n(user_type: faculty)
deactivate Registry

note right of API
  <b>Payment Verification:</b>
  Buyer's STABLECOIN/USDC balance
  already verified in frontend
  
  <i>Multi-currency support available</i>
end note

API -> Trading: create_buy_order()\n{\n  buyer: buyer_wallet,\n  energy_amount: 2,500,000,000,\n  price_per_unit: 0.05,\n  status: \"pending\"\n}

activate Trading

note right of Trading
  <b>Trading Program:</b>
  * Create buy order PDA
  * Store buyer parameters
  * Check order matching eligibility
  
  <i>Automatic matching algorithm</i>
end note

Trading -> Blockchain: Execute on-chain\ncreate_buy_order instruction
activate Blockchain
Blockchain --> Trading: Order created (check)\norder_id: BUY_001
deactivate Blockchain

Trading --> API: Order confirmed
deactivate Trading

API -> OrderDB: Insert buy order\n{\n  order_id: BUY_001,\n  buyer_wallet,\n  order_type: \"buy\",\n  energy: 2.5,\n  price: 0.05,\n  status: \"pending\"\n}

activate OrderDB
OrderDB --> API: Buy order persisted (check)
deactivate OrderDB

API --> Buyer: 201 Created\n{\n  order_id: BUY_001,\n  status: \"pending\",\n  waiting_for_match\n}
deactivate API

note over Buyer
  <b>Buy Order Placed</b>
  Buyer's order in order book
  Waiting for automatic matching
end note

== Order Book State ==

note over OrderDB
  <b>Current Order Book (Epoch: 0:00-0:15):</b>
  
  <b>SELL ORDERS:</b>
  * SELL_001: 2.5 kWh @ 0.05/unit (seller)
  
  <b>BUY ORDERS:</b>
  * BUY_001: 2.5 kWh @ 0.05/unit (buyer)
  
  <b>MATCHING ELIGIBLE:</b>
  Price: 0.05 <= 0.05 (check)
  Quantity: 2.5 = 2.5 (check)
  
  <b>Status: READY FOR CLEARING</b>
  
  <i>Orders will be matched at epoch end</i>
end note

@enduml
