@startuml STEP_4_MARKET_CLEARING
!define AWSPUML https://raw.githubusercontent.com/awslabs/aws-icons-for-plantuml/v14.0/dist
!include AWSPUML/AWSCommon.puml
!include AWSPUML/SecurityIdentityCompliance/IdentityandAccessManagement.puml
!include AWSPUML/Database/RDS.puml

title Step 4: Automated Market Clearing (15-min) Flow\n<size:11>Automated Order Matching and Settlement Process</size>

skinparam backgroundColor #f8f9fa
skinparam RoundCornerSpacing 10
skinparam DefaultFontName Helvetica
skinparam DefaultFontSize 12
skinparam ArrowFontSize 11
skinparam NoteFontSize 11
skinparam ParticipantFontSize 12
skinparam ParticipantFontStyle bold
skinparam ActorFontSize 12
skinparam ActorFontStyle bold
skinparam SequenceMessageAlign center
skinparam BoxPadding 10
skinparam ParticipantPadding 20
skinparam SequenceBoxBorderColor #888888
skinparam NoteBorderColor #4CAF50
skinparam NoteBackgroundColor #E8F5E9

skinparam NoteBorderColor #4CAF50
skinparam NoteBackgroundColor #E8F5E9

participant "Epoch Timer\n(Off-chain Cron)" as Timer #B39DDB
participant "API Gateway\n(Rust/Axum)" as API #E1F5FE
database "PostgreSQL\nOrders Table" as OrderDB #FFF9C4
participant "Oracle Program\n(Anchor/Solana)" as Oracle #FFCCBC
participant "Trading Program\n(Anchor/Solana)" as Trading #FFCCBC
participant "Energy Token\nProgram (SPL)" as TokenProgram #E1BEE7
participant "Solana Blockchain\n(PoA Validator)" as Blockchain #F8BBD0
actor "Seller\n(Prosumer)" as Seller #C8E6C9
actor "Buyer\n(Consumer)" as Buyer #BBDEFB

== End of Trading Epoch: 0:15 ==

note over Timer
  <b>Epoch Timer Trigger:</b>
  Every 15 minutes
  Current time: 0:14:59 to 0:15:00
  
  <i>Automated market clearing initiation</i>
end note

Timer -> API: trigger_epoch_end()\nepoch_id: EPOCH_2025_01_01_00_15

activate API

note right of API
  <b>API Cron Job:</b>
  * Detects epoch end
  * Fetches all pending orders
  * Prepares for market clearing
  
  <i>Scheduled clearing automation</i>
end note

API -> OrderDB: SELECT all orders\nWHERE status='pending'\nAND epoch_id=EPOCH_2025_01_01_00_15
activate OrderDB

note right of OrderDB
  <b>Query order book state:</b>
  * SELL_001: 2.5 kWh @ 0.05 (seller)
  * BUY_001: 2.5 kWh @ 0.05 (buyer)
  
  <b>Sorting algorithm:</b>
  * Sort sell orders (ascending price)
  * Sort buy orders (descending price)
  * Find equilibrium price
  
  <i>Price-time priority matching</i>
end note

OrderDB --> API: Order book results\n(sorted and ready)
deactivate OrderDB

API -> API: Execute matching algorithm\nMatch orders by price/quantity

note right of API
  <b>Matching Engine:</b>
  
  <b>1. Sorted Sell Orders:</b>
     - SELL_001: 2.5 @ 0.05
  
  <b>2. Sorted Buy Orders:</b>
     - BUY_001: 2.5 @ 0.05
  
  <b>3. Equilibrium Price: 0.05</b>
  
  <b>4. Matched Pairs:</b>
     (check) SELL_001 <-> BUY_001
     (check) Energy: 2.5 kWh
     (check) Price: 0.05/unit
  
  <i>Double auction mechanism</i>
end note

API -> Oracle: trigger_market_clearing()\n{\n  epoch_id,\n  matched_orders: [\n    {\n      sell_order_id: SELL_001,\n      buy_order_id: BUY_001,\n      energy_amount: 2500000000,\n      clearing_price: 0.05\n    }\n  ]\n}

activate Oracle

note right of Oracle
  <b>Oracle Program (Market Clearing):</b>
  1. Verify epoch is closed
  2. Validate matched orders
  3. Prepare settlement data
  4. Call Trading program for execution
  
  <i>Trusted settlement coordinator</i>
end note

Oracle -> Trading: execute_market_clearing()\nmarket_clearing_data

activate Trading

note right of Trading
  <b>Trading Program Flow:</b>
  1. Iterate through matched pairs
  2. For each match: settle_trade(sell, buy, amount)
  3. Execute token transfers
  4. Update order statuses
  
  <i>Atomic settlement execution</i>
end note

Trading -> Trading: settle_trade(\n  SELL_001, BUY_001,\n  2500000000 tokens\n)

note over Trading
  <b>Settlement Logic:</b>
  
  <b>For SELL_001 <-> BUY_001:</b>
  1. Seller: Give 2.5 kWh (tokens)
  2. Buyer: Receive 2.5 kWh (tokens)
  3. Seller: Receive payment (0.125)
  4. Buyer: Pay amount (0.125)
  
  <i>Simultaneous token and payment settlement</i>
end note

Trading -> TokenProgram: transfer_tokens(\n  from_ata: seller_ata,\n  to_ata: buyer_ata,\n  amount: 2500000000\n)

activate TokenProgram

note right of TokenProgram
  <b>SPL Token Transfer:</b>
  * Execute approve + transfer
  * Update balances atomically
  * Burn/record transaction
  
  <i>Standard SPL token operations</i>
end note

TokenProgram -> Blockchain: Execute transfer\non-chain instruction
activate Blockchain

note over Blockchain
  <b>Solana Transaction:</b>
  * Source ATA balance: -2.5 kWh
  * Dest ATA balance: +2.5 kWh
  * Update mint state
  * Record transaction hash
  
  <i>Immutable settlement record</i>
end note

Blockchain --> TokenProgram: Transfer confirmed (check)
deactivate Blockchain

TokenProgram --> Trading: Transfer successful\ntx_hash: 0xABC123...
deactivate TokenProgram

Trading -> Blockchain: Update order statuses\nto \"settled\"\n(Batch instruction)

activate Blockchain
Blockchain --> Trading: Status updated (check)
deactivate Blockchain

Trading --> Oracle: Market clearing complete (check)\n{\n  settled_pairs: 1,\n  total_energy: 2.5,\n  clearing_price: 0.05,\n  total_value: 0.125\n}
deactivate Trading

Oracle --> API: Market clearing confirmed
deactivate Oracle

API -> OrderDB: Update orders\nSET status='settled',\n    clearing_price=0.05,\n    settlement_tx_hash=0xABC123...\nWHERE order_id IN (SELL_001, BUY_001)

activate OrderDB
OrderDB --> API: Orders updated (check)
deactivate OrderDB

API -> OrderDB: INSERT settlement record\n{\n  epoch_id: EPOCH_2025_01_01_00_15,\n  matched_pairs: 1,\n  total_energy_traded: 2.5,\n  clearing_price: 0.05,\n  total_value: 0.125,\n  tx_hash: 0xABC123...,\n  timestamp: 2025-01-01 00:15:00\n}

activate OrderDB
OrderDB --> API: Settlement record created (check)
deactivate OrderDB

API --> Seller: Trade settled (check)\n{\n  order_id: SELL_001,\n  status: \"settled\",\n  energy_sold: 2.5 kWh,\n  price: 0.05/unit,\n  total_value: 0.125,\n  payment_pending: true\n}

API --> Buyer: Trade settled (check)\n{\n  order_id: BUY_001,\n  status: \"settled\",\n  energy_bought: 2.5 kWh,\n  price: 0.05/unit,\n  total_cost: 0.125,\n  tokens_received: 2500000000\n}

note over Seller, Buyer
  <b>Trade Complete!</b>
  
  <b>Seller:</b>
  * Sold 2.5 kWh
  * Received payment: 0.125 USDC
  
  <b>Buyer:</b>
  * Bought 2.5 kWh
  * Paid: 0.125 USDC
  * Energy available in ATA
  
  <b>Next Epoch: 0:15-0:30</b>
  New order book opens
  
  <i>Transparent and fair price discovery</i>
end note

== Post-Clearing Summary ==

note over OrderDB
  <b>Market Clearing Report:</b>
  
  <b>Epoch: EPOCH_2025_01_01_00_15</b>
  Duration: 0:00 - 0:15
  
  <b>Orders Processed:</b>
  * Total Orders: 2
  * Matched: 1 pair
  * Settlement Rate: 100%
  
  <b>Market Statistics:</b>
  * Total Energy Traded: 2.5 kWh
  * Clearing Price: 0.05 USDC/kWh
  * Total Value: 0.125 USDC
  * Blockchain Txs: 1
  
  <b>Status: (check) CLEARED and SETTLED</b>
  
  <i>Automated clearing completed successfully</i>
end note

@enduml
