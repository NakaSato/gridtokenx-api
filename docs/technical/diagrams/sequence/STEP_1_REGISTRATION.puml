@startuml STEP_1_REGISTRATION
!define AWSPUML https://raw.githubusercontent.com/awslabs/aws-icons-for-plantuml/v14.0/dist
!include AWSPUML/AWSCommon.puml
!include AWSPUML/SecurityIdentityCompliance/IdentityandAccessManagement.puml
!include AWSPUML/Database/RDS.puml

title Step 1: REC Registration Flow\n<size:11>User Onboarding and Smart Meter Assignment Process</size>

skinparam backgroundColor #f8f9fa
skinparam RoundCornerSpacing 10
skinparam DefaultFontName Helvetica
skinparam DefaultFontSize 12
skinparam ArrowFontSize 11
skinparam NoteFontSize 11
skinparam ParticipantFontSize 12
skinparam ParticipantFontStyle bold
skinparam ActorFontSize 12
skinparam ActorFontStyle bold
skinparam SequenceMessageAlign center
skinparam BoxPadding 10
skinparam ParticipantPadding 20
skinparam SequenceBoxBorderColor #888888
skinparam NoteBorderColor #4CAF50
skinparam NoteBackgroundColor #E8F5E9

actor "REC\n(Renewable Energy Center)" as EngDept #FFB74D
actor "Prosumer/Consumer\n(User)" as User #64B5F6
participant "API Gateway\n(Rust)" as API #90CAF9
participant "Registry Program\n(Anchor/Solana)" as Registry #81C784
database "PostgreSQL\nUsers Table" as UserDB #FFE082
participant "Solana Blockchain\n(PoA Validator)" as Blockchain #CE93D8

== User Registration Process ==

User -> API: POST /register\n{\n  wallet_address,\n  name,\n  email,\n  user_type\n}

activate API
API -> API: Validate input\nCheck wallet format

API -> Blockchain: Verify Solana wallet\nsignature
activate Blockchain
Blockchain --> API: Wallet verified (check)
deactivate Blockchain

API -> Registry: Call register_user()\nPDA: user_authority
activate Registry
note right of Registry
  <b>Anchor Program Instruction:</b>
  * Create user account PDA
  * Store wallet address
  * Set user type (prosumer/consumer)
  * Initialize token balance = 0
  
  <i>PDA ensures deterministic account creation</i>
end note

Registry -> Blockchain: Write user account\non chain
activate Blockchain
Blockchain --> Registry: Account created (check)
deactivate Blockchain

Registry --> API: User registered PDA
deactivate Registry

API -> UserDB: Insert user record\nstore wallet to user mapping
activate UserDB
UserDB --> API: User record saved (check)
deactivate UserDB

API --> User: 200 OK\n{\n  user_id,\n  wallet_address,\n  status: \"registered\",\n  jwt_token\n}
deactivate API

note over User, Blockchain
  <b>Registration Complete</b>
  User is now registered and ready for meter assignment
  JWT token provided for authenticated API access
end note

== Meter Assignment Process ==

EngDept -> API: POST /assign-meter\n{\n  user_id,\n  meter_id (METER_001-015)\n}

activate API
API -> Registry: Call assign_meter()\nPDA: meter_authority
activate Registry

note right of Registry
  <b>Anchor Program Instruction:</b>
  * Verify user exists
  * Verify meter exists
  * Create meter to user mapping
  * Store meter assignment data
  
  <i>Links physical meter to blockchain identity</i>
end note

Registry -> Blockchain: Write meter assignment\non chain
activate Blockchain
Blockchain --> Registry: Meter assigned (check)
deactivate Blockchain

Registry --> API: Meter assignment confirmed
deactivate Registry

API -> UserDB: Update user_meters table\nmeter_id to user mapping
activate UserDB
UserDB --> API: Assignment recorded (check)
deactivate UserDB

API --> EngDept: 200 OK\n{\n  user_id,\n  meter_id,\n  assignment_status: \"active\"\n}
deactivate API

note over EngDept, Blockchain
  <b>Meter Assignment Complete</b>
  Meter is now associated with user
  Ready for AMI data collection
  Energy production/consumption can be tracked
end note

@enduml
