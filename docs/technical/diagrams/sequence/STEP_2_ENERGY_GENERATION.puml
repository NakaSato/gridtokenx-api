@startuml STEP_2_ENERGY_GENERATION
!define AWSPUML https://raw.githubusercontent.com/awslabs/aws-icons-for-plantuml/v14.0/dist
!include AWSPUML/AWSCommon.puml
!include AWSPUML/SecurityIdentityCompliance/IdentityandAccessManagement.puml
!include AWSPUML/Database/RDS.puml

title Step 2: Energy Generation and SPL Token Minting Flow\n<size:11>Smart Meter Data Collection and Token Issuance Process</size>

skinparam backgroundColor #f8f9fa
skinparam RoundCornerSpacing 10
skinparam DefaultFontName Helvetica
skinparam DefaultFontSize 12
skinparam ArrowFontSize 11
skinparam NoteFontSize 11
skinparam ParticipantFontSize 12
skinparam ParticipantFontStyle bold
skinparam ActorFontSize 12
skinparam ActorFontStyle bold
skinparam SequenceMessageAlign center
skinparam BoxPadding 10
skinparam ParticipantPadding 20
skinparam SequenceBoxBorderColor #888888
skinparam NoteBorderColor #4CAF50
skinparam NoteBackgroundColor #E8F5E9

skinparam NoteBorderColor #4CAF50
skinparam NoteBackgroundColor #E8F5E9

actor "REC\n(Renewable Energy Center)" as AMI #FFB74D
participant "Smart Meter\nSimulator (Python)" as Simulator #A5D6A7
participant "Oracle Program\n(Anchor/Solana)" as Oracle #FFA726
participant "Energy Token\nProgram (SPL)" as TokenProgram #AB47BC
participant "Registry Program\n(Anchor/Solana)" as Registry #81C784
database "TimescaleDB\nEnergy Readings" as EnergyDB #FFE082
participant "Solana Blockchain\n(PoA Validator)" as Blockchain #CE93D8
actor "Prosumer/Consumer\n(User)" as User #64B5F6

== Energy Generation Cycle ==

note over AMI, Simulator
  Every 15 minutes: Energy generation data from campus
end note

AMI -> Simulator: Submit AMI data\n{\n  meter_id: METER_001-015,\n  timestamp,\n  kWh_generated,\n  kWh_consumed\n}

activate Simulator
note right of Simulator
  <b>Smart Meter Simulator:</b>
  * Collects AMI readings
  * Validates data format
  * Timestamps readings
  * Queue for Oracle processing
  
  <i>15-minute interval data collection</i>
end note

Simulator -> Simulator: Process meter data\nValidate readings

Simulator -> Oracle: submit_meter_data()\n{\n  meter_id,\n  energy_amount_kwh,\n  timestamp\n}
deactivate Simulator

activate Oracle

note right of Oracle
  <b>Oracle Program Flow:</b>
  1. Verify meter ownership via Registry
  2. Calculate token amount (kWh x 1e9)
  3. Execute SPL token mint
  4. Store energy reading on-chain
  
  <i>Trusted oracle validates and processes data</i>
end note

Oracle -> Registry: Verify meter\nget_meter_owner(meter_id)
activate Registry

note right of Registry
  <b>Registry Program:</b>
  * Lookup meter_id in accounts
  * Return owner wallet address
  * Verify user is registered
  
  <i>On-chain authority verification</i>
end note

Registry --> Oracle: Owner: user_wallet (check)
deactivate Registry

Oracle -> Oracle: Calculate token amount\ntoken_amount = kWh x 10^9

note over Oracle
  <b>Token Calculation Example:</b>
  5 kWh generated = 5,000,000,000 tokens
  (9 decimal places for SPL standard)
end note

Oracle -> TokenProgram: mint_to()\n{\n  mint_authority: oracle_pda,\n  destination_ata: user_ata,\n  amount: token_amount,\n  signer: oracle_pda\n}

activate TokenProgram

note right of TokenProgram
  <b>SPL Token Program (Standard):</b>
  * Update mint supply
  * Create/verify user ATA
  * Transfer tokens to user ATA
  * Emit transfer event
  
  <i>Standard Solana token operations</i>
end note

TokenProgram -> Blockchain: Execute on-chain\nmint_to instruction
activate Blockchain

note over Blockchain
  <b>Solana Blockchain:</b>
  * Update TokenMetadata
  * Update user ATA balance
  * Record transaction
  * Emit MintTo event
  
  <i>Immutable energy credit record</i>
end note

Blockchain --> TokenProgram: Mint confirmed (check)
deactivate Blockchain

TokenProgram --> Oracle: Mint successful\n{\n  tx_hash,\n  amount_minted,\n  new_balance: user_ata\n}
deactivate TokenProgram

Oracle -> EnergyDB: Store energy reading\n{\n  meter_id,\n  user_id,\n  kWh_generated,\n  tokens_minted,\n  timestamp\n}

activate EnergyDB
note right of EnergyDB
  <b>TimescaleDB (Time-Series):</b>
  * Store AMI readings
  * Index by meter_id and timestamp
  * Hypertable: 15-min chunks
  * For analytics and dashboards
  
  <i>Optimized for time-series queries</i>
end note

EnergyDB --> Oracle: Record stored (check)
deactivate EnergyDB

Oracle --> Simulator: Energy processed\n{\n  meter_id,\n  tokens_minted,\n  tx_hash\n}
deactivate Oracle

Simulator --> AMI: AMI data processed (check)
activate AMI
note right of AMI
  <b>Processing Complete:</b>
  * Energy recorded in system
  * User receives SPL tokens
  * Ready for trading
  
  <i>End-to-end data verification</i>
end note
deactivate AMI

Oracle --> User: User ATA updated\n5,000,000,000 ENG_GRID tokens credited

note over User
  <b>Token Issuance Complete</b>
  User now has energy tokens
  Available for trading in next epoch
  Blockchain-verified energy credits
end note

@enduml
