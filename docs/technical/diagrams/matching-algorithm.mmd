%% Matching Algorithm Flowchart
%% Render this diagram using Mermaid: https://mermaid.live

flowchart TD
    Start([Start Matching Cycle]) --> GetBest
    
    GetBest[Get Best Bid & Best Ask] --> CheckExists
    
    CheckExists{Both<br/>exist?} -->|No| End([End Cycle])
    CheckExists -->|Yes| CheckPrice
    
    CheckPrice{Bid Price<br/>>= Ask Price?} -->|No| End
    CheckPrice -->|Yes| CalcQty
    
    CalcQty[Calculate Match Quantity<br/>qty = min bid_remaining, ask_remaining] --> CalcPrice
    
    CalcPrice[Set Execution Price<br/>price = ask_price] --> UpdateBuy
    
    UpdateBuy[Update Buy Order<br/>filled_amount += qty] --> UpdateSell
    
    UpdateSell[Update Sell Order<br/>filled_amount += qty] --> CheckBuyFilled
    
    CheckBuyFilled{Buy Order<br/>Fully Filled?} -->|Yes| RemoveBuy
    CheckBuyFilled -->|No| CheckSellFilled
    
    RemoveBuy[Remove Buy Order<br/>from Order Book] --> CheckSellFilled
    
    CheckSellFilled{Sell Order<br/>Fully Filled?} -->|Yes| RemoveSell
    CheckSellFilled -->|No| CreateTrade
    
    RemoveSell[Remove Sell Order<br/>from Order Book] --> CreateTrade
    
    CreateTrade[Create Trade Match Record] --> PersistDB
    
    PersistDB[Persist to PostgreSQL] --> BroadcastWS
    
    BroadcastWS[Broadcast via WebSocket] --> SubmitSettle
    
    SubmitSettle[Submit to Settlement Service] --> GetBest
    
    style Start fill:#4CAF50,stroke:#333,stroke-width:2px,color:#fff
    style End fill:#F44336,stroke:#333,stroke-width:2px,color:#fff
    style CalcQty fill:#2196F3,stroke:#333,stroke-width:2px,color:#fff
    style CreateTrade fill:#FF9800,stroke:#333,stroke-width:2px,color:#fff
    style SubmitSettle fill:#9C27B0,stroke:#333,stroke-width:2px,color:#fff
